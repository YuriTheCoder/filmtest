// Cinema App - Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  role         UserRole @default(USER)
  avatarUrl    String?
  bio          String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  reviews       Review[]
  favorites     Favorite[]
  watchlist     Watchlist[]
  refreshTokens RefreshToken[]

  @@index([email])
  @@map("users")
}

model Genre {
  id        String   @id @default(cuid())
  tmdbId    Int?     @unique
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  movies Movie[]

  @@index([slug])
  @@index([tmdbId])
  @@map("genres")
}

model Movie {
  id               String   @id @default(cuid())
  tmdbId           Int?     @unique
  title            String
  slug             String   @unique
  synopsis         String   @db.Text
  year             Int
  runtime          Int      // minutes
  country          String   @default("US")
  originalLanguage String   @default("en")
  directors        String[] // JSON array
  cast             String[] // JSON array
  posterUrl        String?
  backdropUrl      String?
  trailerUrl       String?
  parentalRating   String?  // G, PG, PG-13, R, NC-17, etc
  popularity       Float    @default(0) @db.Real
  avgRating        Float    @default(0) @db.Real
  ratingsCount     Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  genres    Genre[]
  reviews   Review[]
  favorites Favorite[]
  watchlist Watchlist[]

  @@index([slug])
  @@index([tmdbId])
  @@index([popularity])
  @@index([avgRating])
  @@index([year])
  @@index([createdAt])
  @@map("movies")
}

model Review {
  id        String   @id @default(cuid())
  movieId   String
  userId    String
  rating    Int      // 0-10 (or 1-5 * 2 for half stars)
  title     String?
  body      String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  movie Movie @relation(fields: [movieId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId])
  @@index([movieId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}

model Favorite {
  id        String   @id @default(cuid())
  movieId   String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  movie Movie @relation(fields: [movieId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId])
  @@index([userId])
  @@index([movieId])
  @@index([createdAt])
  @@map("favorites")
}

model Watchlist {
  id        String   @id @default(cuid())
  movieId   String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  movie Movie @relation(fields: [movieId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId])
  @@index([userId])
  @@index([movieId])
  @@index([createdAt])
  @@map("watchlist")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

model SyncLog {
  id        String   @id @default(cuid())
  type      String   // 'TMDB_SYNC', 'MANUAL_IMPORT', etc
  status    String   // 'SUCCESS', 'FAILURE', 'PARTIAL'
  message   String?  @db.Text
  stats     Json?    // JSON with sync statistics
  createdAt DateTime @default(now())

  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("sync_logs")
}
